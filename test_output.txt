  console.log
    Processing message for user 123

      at Object.log [as info] (src/logger.js:47:17)

  console.log
    Using OpenCode mode

      at Object.log [as debug] (src/logger.js:65:17)

  console.log
    Executing: yes | opencode "run" "--format" "json" "--model" "opencode/test-model" "--" "User: Hello
    Please provide a short response:"

      at Object.log [as debug] (src/logger.js:65:17)

  console.log
    AI response received for user 123

      at Object.log [as success] (src/logger.js:71:17)

  console.log
    Processing message for user 123

      at Object.log [as info] (src/logger.js:47:17)

  console.log
    Using OpenCode mode

      at Object.log [as debug] (src/logger.js:65:17)

  console.log
    Executing: yes | opencode "run" "--format" "json" "--model" "opencode/test-model" "--" "User: test
    Please provide a short response:"

      at Object.log [as debug] (src/logger.js:65:17)

  console.log
    AI response received for user 123

      at Object.log [as success] (src/logger.js:71:17)

  console.log
    Processing message for user 123

      at Object.log [as info] (src/logger.js:47:17)

  console.log
    Using OpenCode mode

      at Object.log [as debug] (src/logger.js:65:17)

  console.log
    Executing: yes | opencode "run" "--format" "json" "--model" "opencode/test-model" "--" "User: test
    Please provide a short response:"

      at Object.log [as debug] (src/logger.js:65:17)

  console.log
    opencode stderr: error message

      at Object.log [as debug] (src/logger.js:65:17)

  console.error
    opencode exited with code 1

    [0m [90m 57 |[39m     error(message[33m,[39m error [33m=[39m [36mnull[39m) {
     [90m 58 |[39m         [36mconst[39m text [33m=[39m formatLog([32m'ERROR'[39m[33m,[39m message[33m,[39m error)[33m;[39m
    [31m[1m>[22m[39m[90m 59 |[39m         console[33m.[39merror(message)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 60 |[39m         writeToFile(text)[33m;[39m
     [90m 61 |[39m     }[33m,[39m
     [90m 62 |[39m     [0m

      at Object.error (src/logger.js:59:17)
      at error (src/ai.js:108:24)
      at Object.cb (processMessage.test.js:59:40)
      at on (src/ai.js:104:15)
      at callOpenCode (src/ai.js:63:12)
      at callOpenCode (src/ai.js:155:36)
      at Object.processMessage (processMessage.test.js:64:22)

  console.error
    OpenCode error: error message

    [0m [90m 57 |[39m     error(message[33m,[39m error [33m=[39m [36mnull[39m) {
     [90m 58 |[39m         [36mconst[39m text [33m=[39m formatLog([32m'ERROR'[39m[33m,[39m message[33m,[39m error)[33m;[39m
    [31m[1m>[22m[39m[90m 59 |[39m         console[33m.[39merror(message)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 60 |[39m         writeToFile(text)[33m;[39m
     [90m 61 |[39m     }[33m,[39m
     [90m 62 |[39m     [0m

      at Object.error (src/logger.js:59:17)
      at error (src/ai.js:159:20)
      at Object.<anonymous> (processMessage.test.js:64:9)

  console.log
    Processing message for user 123

      at Object.log [as info] (src/logger.js:47:17)

  console.log
    Using OpenCode mode

      at Object.log [as debug] (src/logger.js:65:17)

  console.log
    Executing: yes | opencode "run" "--format" "json" "--model" "opencode/test-model" "--" "User: test
    Please provide a short response:"

      at Object.log [as debug] (src/logger.js:65:17)

  console.log
    AI response received for user 123

      at Object.log [as success] (src/logger.js:71:17)

  console.log
    Processing message for user 123

      at Object.log [as info] (src/logger.js:47:17)

  console.log
    Using OpenCode mode

      at Object.log [as debug] (src/logger.js:65:17)

  console.log
    Executing: yes | opencode "run" "--format" "json" "--model" "opencode/test-model" "--" "User: test
    Please provide a short response:"

      at Object.log [as debug] (src/logger.js:65:17)

  console.error
    opencode timed out after 60 seconds

    [0m [90m 57 |[39m     error(message[33m,[39m error [33m=[39m [36mnull[39m) {
     [90m 58 |[39m         [36mconst[39m text [33m=[39m formatLog([32m'ERROR'[39m[33m,[39m message[33m,[39m error)[33m;[39m
    [31m[1m>[22m[39m[90m 59 |[39m         console[33m.[39merror(message)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 60 |[39m         writeToFile(text)[33m;[39m
     [90m 61 |[39m     }[33m,[39m
     [90m 62 |[39m     [0m

      at Object.error (src/logger.js:59:17)
      at error (src/ai.js:133:20)
      at callTimer (C:/Users/chiis/AppData/Local/npm-cache/_npx/b8d86e6551a4f492/node_modules/@sinonjs/fake-timers/src/fake-timers-src.js:806:24)
      at doTickInner (C:/Users/chiis/AppData/Local/npm-cache/_npx/b8d86e6551a4f492/node_modules/@sinonjs/fake-timers/src/fake-timers-src.js:1413:29)
      at doTick (C:/Users/chiis/AppData/Local/npm-cache/_npx/b8d86e6551a4f492/node_modules/@sinonjs/fake-timers/src/fake-timers-src.js:1494:20)
      at Object.tick (C:/Users/chiis/AppData/Local/npm-cache/_npx/b8d86e6551a4f492/node_modules/@sinonjs/fake-timers/src/fake-timers-src.js:1502:20)
      at FakeTimers.advanceTimersByTime (C:/Users/chiis/AppData/Local/npm-cache/_npx/b8d86e6551a4f492/node_modules/@jest/fake-timers/build/index.js:576:19)
      at Object.advanceTimersByTime (processMessage.test.js:98:14)

  console.error
    OpenCode error: opencode timed out after 60 seconds

    [0m [90m 57 |[39m     error(message[33m,[39m error [33m=[39m [36mnull[39m) {
     [90m 58 |[39m         [36mconst[39m text [33m=[39m formatLog([32m'ERROR'[39m[33m,[39m message[33m,[39m error)[33m;[39m
    [31m[1m>[22m[39m[90m 59 |[39m         console[33m.[39merror(message)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 60 |[39m         writeToFile(text)[33m;[39m
     [90m 61 |[39m     }[33m,[39m
     [90m 62 |[39m     [0m

      at Object.error (src/logger.js:59:17)
      at error (src/ai.js:159:20)
      at Object.<anonymous> (processMessage.test.js:100:9)

  console.log
    Processing message for user 123

      at Object.log [as info] (src/logger.js:47:17)

  console.log
    Using OpenCode mode

      at Object.log [as debug] (src/logger.js:65:17)

  console.log
    Executing: yes | opencode "run" "--format" "json" "--model" "opencode/test-model" "--" "User: test
    Please provide a short response:"

      at Object.log [as debug] (src/logger.js:65:17)

  console.log
    opencode stderr: authentication failed

      at Object.log [as debug] (src/logger.js:65:17)

  console.error
    opencode exited with code 1

    [0m [90m 57 |[39m     error(message[33m,[39m error [33m=[39m [36mnull[39m) {
     [90m 58 |[39m         [36mconst[39m text [33m=[39m formatLog([32m'ERROR'[39m[33m,[39m message[33m,[39m error)[33m;[39m
    [31m[1m>[22m[39m[90m 59 |[39m         console[33m.[39merror(message)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 60 |[39m         writeToFile(text)[33m;[39m
     [90m 61 |[39m     }[33m,[39m
     [90m 62 |[39m     [0m

      at Object.error (src/logger.js:59:17)
      at error (src/ai.js:108:24)
      at Object.cb (processMessage.test.js:113:40)
      at on (src/ai.js:104:15)
      at callOpenCode (src/ai.js:63:12)
      at callOpenCode (src/ai.js:155:36)
      at Object.processMessage (processMessage.test.js:118:22)

  console.error
    OpenCode error: authentication failed

    [0m [90m 57 |[39m     error(message[33m,[39m error [33m=[39m [36mnull[39m) {
     [90m 58 |[39m         [36mconst[39m text [33m=[39m formatLog([32m'ERROR'[39m[33m,[39m message[33m,[39m error)[33m;[39m
    [31m[1m>[22m[39m[90m 59 |[39m         console[33m.[39merror(message)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 60 |[39m         writeToFile(text)[33m;[39m
     [90m 61 |[39m     }[33m,[39m
     [90m 62 |[39m     [0m

      at Object.error (src/logger.js:59:17)
      at error (src/ai.js:159:20)
      at Object.<anonymous> (processMessage.test.js:118:9)

  console.log
    Processing message for user 123

      at Object.log [as info] (src/logger.js:47:17)

  console.log
    Using OpenCode mode

      at Object.log [as debug] (src/logger.js:65:17)

  console.log
    Executing: yes | opencode "run" "--format" "json" "--model" "opencode/test-model" "--" "User: test
    Please provide a short response:"

      at Object.log [as debug] (src/logger.js:65:17)

  console.log
    opencode stderr: rate limit exceeded

      at Object.log [as debug] (src/logger.js:65:17)

  console.error
    opencode exited with code 1

    [0m [90m 57 |[39m     error(message[33m,[39m error [33m=[39m [36mnull[39m) {
     [90m 58 |[39m         [36mconst[39m text [33m=[39m formatLog([32m'ERROR'[39m[33m,[39m message[33m,[39m error)[33m;[39m
    [31m[1m>[22m[39m[90m 59 |[39m         console[33m.[39merror(message)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 60 |[39m         writeToFile(text)[33m;[39m
     [90m 61 |[39m     }[33m,[39m
     [90m 62 |[39m     [0m

      at Object.error (src/logger.js:59:17)
      at error (src/ai.js:108:24)
      at Object.cb (processMessage.test.js:126:40)
      at on (src/ai.js:104:15)
      at callOpenCode (src/ai.js:63:12)
      at callOpenCode (src/ai.js:155:36)
      at Object.processMessage (processMessage.test.js:131:22)

  console.error
    OpenCode error: rate limit exceeded

    [0m [90m 57 |[39m     error(message[33m,[39m error [33m=[39m [36mnull[39m) {
     [90m 58 |[39m         [36mconst[39m text [33m=[39m formatLog([32m'ERROR'[39m[33m,[39m message[33m,[39m error)[33m;[39m
    [31m[1m>[22m[39m[90m 59 |[39m         console[33m.[39merror(message)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 60 |[39m         writeToFile(text)[33m;[39m
     [90m 61 |[39m     }[33m,[39m
     [90m 62 |[39m     [0m

      at Object.error (src/logger.js:59:17)
      at error (src/ai.js:159:20)
      at Object.<anonymous> (processMessage.test.js:131:9)

  console.log
    Processing message for user 123

      at Object.log [as info] (src/logger.js:47:17)

  console.log
    Using OpenCode mode

      at Object.log [as debug] (src/logger.js:65:17)

  console.log
    Executing: yes | opencode "run" "--format" "json" "--model" "opencode/test-model" "--" "User: test
    Please provide a short response:"

      at Object.log [as debug] (src/logger.js:65:17)

  console.log
    opencode stderr: some other error

      at Object.log [as debug] (src/logger.js:65:17)

  console.error
    opencode exited with code 1

    [0m [90m 57 |[39m     error(message[33m,[39m error [33m=[39m [36mnull[39m) {
     [90m 58 |[39m         [36mconst[39m text [33m=[39m formatLog([32m'ERROR'[39m[33m,[39m message[33m,[39m error)[33m;[39m
    [31m[1m>[22m[39m[90m 59 |[39m         console[33m.[39merror(message)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 60 |[39m         writeToFile(text)[33m;[39m
     [90m 61 |[39m     }[33m,[39m
     [90m 62 |[39m     [0m

      at Object.error (src/logger.js:59:17)
      at error (src/ai.js:108:24)
      at Object.cb (processMessage.test.js:139:40)
      at on (src/ai.js:104:15)
      at callOpenCode (src/ai.js:63:12)
      at callOpenCode (src/ai.js:155:36)
      at Object.processMessage (processMessage.test.js:144:22)

  console.error
    OpenCode error: some other error

    [0m [90m 57 |[39m     error(message[33m,[39m error [33m=[39m [36mnull[39m) {
     [90m 58 |[39m         [36mconst[39m text [33m=[39m formatLog([32m'ERROR'[39m[33m,[39m message[33m,[39m error)[33m;[39m
    [31m[1m>[22m[39m[90m 59 |[39m         console[33m.[39merror(message)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 60 |[39m         writeToFile(text)[33m;[39m
     [90m 61 |[39m     }[33m,[39m
     [90m 62 |[39m     [0m

      at Object.error (src/logger.js:59:17)
      at error (src/ai.js:159:20)
      at Object.<anonymous> (processMessage.test.js:144:9)

FAIL ./processMessage.test.js
  ai.js - processMessage
    Ã— processMessage should call opencode with correct prompt (37 ms)
    âˆš processMessage should set correct environment variables (5 ms)
    âˆš processMessage should handle opencode error (18 ms)
    âˆš processMessage should clean ANSI escape codes (4 ms)
    âˆš processMessage should timeout after 60 seconds (11 ms)
    Ã— processMessage should handle authentication error (12 ms)
    Ã— processMessage should handle rate limit error (12 ms)
    âˆš processMessage should handle generic error (8 ms)

  â— ai.js - processMessage â€º processMessage should call opencode with correct prompt

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      "sh",
      Array [
        "-c",
    -   "yes | opencode \"run\" \"--format\" \"json\" \"--\" \"User: Hello
    +   "yes | opencode \"run\" \"--format\" \"json\" \"--model\" \"opencode/test-model\" \"--\" \"User: Hello
      Please provide a short response:\"",
      ],
      {"env": [Object]},

    Number of calls: 1

      29 |
      30 |         const expectedCommand = `yes | opencode "run" "--format" "json" "--" "User: Hello\nPlease provide a short response:"`;
    > 31 |         expect(spawn).toHaveBeenCalledWith('sh', ['-c', expectedCommand], { env: expect.any(Object) });
         |                       ^
      32 |         expect(result).toBe('Hello from AI');
      33 |     });
      34 |

      at Object.toHaveBeenCalledWith (processMessage.test.js:31:23)

  â— ai.js - processMessage â€º processMessage should handle authentication error

    expect(received).rejects.toThrow(expected)

    Expected substring: "Authentication failed"
    Received message:   "authentication failed"

          107 |             if (code !== 0) {
          108 |                 logger.error(`opencode exited with code ${code}`);
        > 109 |                 reject(new Error(stderr || `opencode failed with exit code ${code}`));
              |                        ^
          110 |                 return;
          111 |             }
          112 |

      at src/ai.js:109:24
      at Object.cb (processMessage.test.js:113:40)
      at on (src/ai.js:104:15)
      at callOpenCode (src/ai.js:63:12)
      at callOpenCode (src/ai.js:155:36)
      at Object.processMessage (processMessage.test.js:118:22)
      at Object.toThrow (C:/Users/chiis/AppData/Local/npm-cache/_npx/b8d86e6551a4f492/node_modules/expect/build/index.js:2155:20)
      at Object.toThrow (processMessage.test.js:118:63)

  â— ai.js - processMessage â€º processMessage should handle rate limit error

    expect(received).rejects.toThrow(expected)

    Expected substring: "Rate limit exceeded"
    Received message:   "rate limit exceeded"

          107 |             if (code !== 0) {
          108 |                 logger.error(`opencode exited with code ${code}`);
        > 109 |                 reject(new Error(stderr || `opencode failed with exit code ${code}`));
              |                        ^
          110 |                 return;
          111 |             }
          112 |

      at src/ai.js:109:24
      at Object.cb (processMessage.test.js:126:40)
      at on (src/ai.js:104:15)
      at callOpenCode (src/ai.js:63:12)
      at callOpenCode (src/ai.js:155:36)
      at Object.processMessage (processMessage.test.js:131:22)
      at Object.toThrow (C:/Users/chiis/AppData/Local/npm-cache/_npx/b8d86e6551a4f492/node_modules/expect/build/index.js:2155:20)
      at Object.toThrow (processMessage.test.js:131:63)

Test Suites: 1 failed, 1 total
Tests:       3 failed, 5 passed, 8 total
Snapshots:   0 total
Time:        0.399 s, estimated 1 s
Ran all test suites matching processMessage.
Jest did not exit one second after the test run has completed.

'This usually means that there are asynchronous operations that weren't stopped in your tests. Consider running Jest with `--detectOpenHandles` to troubleshoot this issue.
D:\github\chiisen\MiniOC\src\ai.js:117
      child.kill();
            ^

[TypeError: child.kill is not a function]

Node.js v22.21.1
